{% extends 'base.html' %}

{% load static %}

{% block style %}
<link rel="stylesheet" href="{% static 'chat.css' %}" />

{% endblock style %}

{% block title %}
<title>Chat Room</title>
{% endblock title %}


{% block content %}


<div id="frame">
  <div class="content">
    <div class="contact-profile">
      <img src="" alt="" />
      <p>{{ name }} | {{ room }}</p>
    </div>
    <div class="messages">
      <ul id="chat-log">
      </ul>
    </div>
    <div class="message-input">
      <div class="wrap" style="position: fixed; bottom: 10px; right: 10px;">
        <input id="chat-message-input" type="text" placeholder="پیامت رو بنویس..." />
        <button onclick="document.getElementById('inp').click();">عکس</button>
        <button id="chat-message-submit" class="submit">
          <!-- <i class="fa fa-paper-plane" aria-hidden="true"></i> -->
          ارسال
        </button>
      </div>
    </div>
  </div>
</div>

<input id="inp" type='file' accept="image/*" style="display: none;">
<p id="b64"></p>

{{ room_id|json_script:"room-id" }}
<script src="{% static 'reconnecting-ws.js' %}"></script>
<script>
  const roomID = JSON.parse(
    document.getElementById("room-id").textContent
  );

  var username = {{ username }}

  const chatSocket = new ReconnectingWebSocket(
    "ws://" + window.location.host + "/ws/id/" + roomID + "/"
  );

  const chatSocket2 = new WebSocket(
    "ws://" + window.location.host + "/ws/id/BFoULH5Z/"
  );

  chatSocket2.onmessage = function (e) {
    var data = JSON.parse(e.data)
    for (let i = data["members_list"].length - 1; i >= 0; i--) {
      if (data["members_list"][i] == username) {
        if (data["author"] != username) {
          if (data["room_id"] != roomID) {
            if ("Notification" in window) {
              var button = document.getElementById("notification-click")

              if (Notification.permission === 'granted') {
                var notification = new Notification(`کاربر "${data["author"]}" در "${data["room_name"]}" نوشت: ${data["message"]}`)
              }
              else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function (permission) {
                  if (permission === "granted") {
                    var notification = new Notification(`کاربر "${data["author"]}" در "${data["room_name"]}" نوشت: ${data["message"]}`)
                  }
                })
              }
            }

          }
        }
      }
    }
  };



  chatSocket.onopen = function (e) {
    chatSocket.send(
      JSON.stringify({
        command: "fetch_message",
        room_name: roomID,
      })
    );
    document.getElementById("chat-log").innerHTML = "";
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    createMessage(data)
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  document.querySelector("#chat-message-input").focus();
  document.querySelector("#chat-message-input").onkeyup = function (e) {
    if (e.keyCode === 13) {
      // enter, return
      document.querySelector("#chat-message-submit").click();
    }
  };

  document.querySelector("#chat-message-submit").onclick = function (e) {
    const messageInputDom = document.querySelector("#chat-message-input");
    const message = messageInputDom.value;
    chatSocket.send(
      JSON.stringify({
        message: message,
        command: "new_message",
        username: username,
        room_name: roomID,
      })
    );
    messageInputDom.value = "";
  };

  function createMessage(data) {
    var author = data.author;
    var command = data.command;
    var messageListTag = document.createElement('li');
    if (command === "send_image") {
      var content = document.createElement('img');
      content.src = data.message;
    } else {
      var content = document.createElement('p');
      content.textContent = data.message;
    }
    if (author === username) {
      messageListTag.className = 'sent';
    } else {
      messageListTag.className = 'replies';
    }
    messageListTag.appendChild(content);
    document.querySelector("#chat-log").appendChild(messageListTag);
  }

  function readFile() {
    if (this.files && this.files[0]) {
      var FR = new FileReader();
      FR.addEventListener("load", function (e) {
        chatSocket.send(JSON.stringify({
          message: e.target.result,
          command: 'send_image',
          username: username,
          room_name: roomID,
        }))
      });
      FR.readAsDataURL(this.files[0]);
    }
  }
  document.getElementById("inp").addEventListener("change", readFile);
</script>
{% endblock content %}