{% load static %}
<!DOCTYPE html>
<html lang="en" style="zoom: 100%;">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="{% static 'assets/favicon.ico' %}" type="image/x-icon">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}" />
  <title>{{ room }} - چتگرام</title>
</head>
<div class="container" style="direction: rtl;">
  <div class="chat-label">
    <a href="/chat/{{ room }}">{{ room }}</a>
    <a href="{% url 'index' %}">بازگشت</a>
  </div>
  <div class="chat-body">
    <div class="messages">
    </div>
    <div class="message-input" style="position: fixed; bottom: 10px; right: 10px;">
      <input id="chat-message-input" type="text" placeholder="پیامت رو بنویس..." />
      <button class="send-msg" id="chat-message-submit" class="submit">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send"
          viewBox="0 0 16 16">
          <path
            d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z" />
        </svg>
      </button>
      <button class="send-img" onclick="document.getElementById('inp').click();">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image"
          viewBox="0 0 16 16">
          <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z" />
          <path
            d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z" />
        </svg>
      </button>
    </div>
  </div>
</div>


<input id="inp" type='file' accept="image/*" style="display: none;">
<p id="b64"></p>

{{ room_id|json_script:"room-id" }}
<script src="{% static 'js/reconnecting-ws.js' %}"></script>
<script>
  const roomID = JSON.parse(document.getElementById("room-id").textContent);
  var username = {{ username }}

  const chatSocket = new ReconnectingWebSocket(
    "ws://" + window.location.host + "/ws/id/" + roomID + "/"
  );

  const chatSocket2 = new WebSocket(
    "ws://" + window.location.host + "/ws/id/BFoULH5Z/"
  );

  chatSocket2.onmessage = function (e) {
    var data = JSON.parse(e.data);
    for (let i = data["members_list"].length - 1; i >= 0; i--) {
      if (data["members_list"][i] == username) {
        if (data["author"] != username) {
          if (data["room_id"] != roomID) {
            if ("Notification" in window) {
              var button = document.getElementById("notification-click");

              if (Notification.permission === "granted") {
                var notification = new Notification(
                  `کاربر "${data["author"]}" در "${data["room_name"]}" نوشت: ${data["message"]}`
                );
              } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                  if (permission === "granted") {
                    var notification = new Notification(
                      `کاربر "${data["author"]}" در "${data["room_name"]}" نوشت: ${data["message"]}`
                    );
                  }
                });
              }
            }
          }
        }
      }
    }
  };

  chatSocket.onopen = function (e) {
    chatSocket.send(
      JSON.stringify({
        command: "fetch_message",
        room_name: roomID,
      })
    );
    document.getElementsByClassName("messages").innerHTML = "";
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    createMessage(data);
  };

  chatSocket.onclose = function (e) {
    console.error("Chat socket closed unexpectedly");
  };

  document.querySelector("#chat-message-input").focus();
  document.querySelector("#chat-message-input").onkeyup = function (e) {
    if (e.keyCode === 13) {
      // enter, return
      document.querySelector("#chat-message-submit").click();
    }
  };

  document.querySelector("#chat-message-submit").onclick = function (e) {
    const messageInputDom = document.querySelector("#chat-message-input");
    const message = messageInputDom.value;
    chatSocket.send(
      JSON.stringify({
        message: message,
        command: "new_message",
        username: username,
        room_name: roomID,
      })
    );
    messageInputDom.value = "";
  };

  // TODO
  // <div class="time">14:15 PM</div>

  function createMessage(data) {
    var author = data.author;
    var command = data.command;
    var message = document.createElement("div");
    var messageAuthor = document.createElement("div");
    messageAuthor.className = "name";
    messageAuthor.textContent = author;
    message.appendChild(messageAuthor);
    if (command === "send_image") {
      var content = document.createElement("img");
      // TODO change class name
      content.className = "follan";
      content.src = data.message;
    } else {
      var content = document.createElement("div");
      content.className = "text";
      content.textContent = data.message;
    }
    if (author === username) {
      message.className = "answer right";
    } else {
      message.className = "answer left";
    }
    message.appendChild(content);
    var messageTime = document.createElement("div");
    messageTime.className = "time";
    messageTime.textContent = "14:50 PM";
    message.appendChild(messageTime);
    document.querySelector(".messages").appendChild(message);
  }

  function readFile() {
    if (this.files && this.files[0]) {
      var FR = new FileReader();
      FR.addEventListener("load", function (e) {
        chatSocket.send(
          JSON.stringify({
            message: e.target.result,
            command: "send_image",
            username: username,
            room_name: roomID,
          })
        );
      });
      FR.readAsDataURL(this.files[0]);
    }
  }
  document.getElementById("inp").addEventListener("change", readFile);

</script>
</body>

</html>